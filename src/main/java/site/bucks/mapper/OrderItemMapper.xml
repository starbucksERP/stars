<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="site.bucks.mapper.OrderItemMapper">
<!-- 지점 발주시 -->
	<!-- order_item : 지점 발주 테이블에 기록시 주문 기록(주체가 order) -->
	<sql id="orderItemPprice">
	 	(select item_Pprice from item where item_num=#{itemNum})
	</sql>
	<sql id="orderItemSprice">
	 	(select item_Sprice from item where item_num=#{itemNum})
	</sql>
	<insert id="insertStoreOrder" parameterType="OrderItem">
		<selectKey resultType="int" keyProperty="orderSeq" order="BEFORE">
			select order_seq.nextval from dual		
		</selectKey>
		insert into order_item values(#{orderSeq}, #{requestNum}, #{storeId}, #{itemNum},
		 #{orderQty}, <include refid="orderItemPprice"/>, <include refid="orderItemSprice"/>, 10, sysdate, null, 0)
	</insert>
	
<!-- 지점 발주시 -->

<!-- 지점 발주 조회 -->
	<select id="selectStoreOrderItemList" resultType="OrderItem">
		select * from order_item <!--where STORE_ID=#{storeId}
			 <if test="requestDate!=null and requestDate!=''">
				AND REQUEST_DATE BETWEEN #{requestDate} AND #{requestDatePair}
			</if>
			<if test="itemNum!=null and itemNum!=''">
				AND ITEM_NUM!=null=#{itemNum}
			</if>
			<if test="price1!=null and price1!='' and price2!=null and price2!=''">
				AND ITEM_SPRICE between #{price1} and #{price2}
			</if> -->
		order by REQUEST_DATE desc
	</select>
<!-- 지점 발주 조회 -->

<!-- 지점 입고 확인시 storeItemHistory 테이블에서 일어나는 일련의 메소드 -->
	<!-- order_item : 지점에서 입고확인시 주문상태 변화 -->
	<update id="updateOrderReceiptProcess" parameterType="OrderItem">
		update order_item set request_state=#{requestState} where request_num=#{requestNum}
	</update>
<!-- 지점 입고 확인시 storeItemHistory 테이블에서 일어나는 일련의 메소드 -->



<!--  ******************************* 본점관련SQL *********************************************** -->

	<!-- 요청번호들을 전달받아 값을 변경 -->
	<update id="updateOrderItemState">
		update order_item set request_state=#{requestState} where request_num in
		<foreach collection="reqNums" item="requestNum" open="(" close=")" separator=",">
			#{requestNum}
		</foreach>
	</update>
	
	<!-- 검색 -->
	<select id="selectOrderItemList" resultType="OrderItem">
		select * from order_item
		<where>
			<if test="requestDate!=null and requestDate!=''">
				to_char(REQUEST_DATE,'yyyy-mm-dd') BETWEEN #{requestDate} AND #{requestDatePair}
			</if>
			<if test="requestNum!=null and requestNum!=''">
				AND request_num like '%'||#{requestNum}||'%'
			</if>
			<if test="storeId!=null and storeId!=0">
				AND STORE_ID=#{storeId}
			</if>
			<if test="itemNum!=null and itemNum!=''">
				AND ITEM_NUM=#{itemNum}
			</if>
			<if test="orderType!=null and orderType!=0">
				AND order_type=#{orderType}
			</if>
			<if test="states!=null">
				AND REQUEST_STATE IN
				<foreach collection="states" item="state" open="(" close=")" separator=",">
				 	#{state}
				</foreach>
			</if>
		</where>
		order by REQUEST_DATE desc
	</select>
	
	<select id="selectOrderItemListAll" resultType="OrderItem">
		select * from order_item order by REQUEST_DATE desc
	</select>
	
	<!-- 요청번호에 대한 오더들 반환  -->
	<select id="selectOrderItems" parameterType="String" resultType="OrderItem">
		select * from order_item where request_num=#{requestNum}
	</select>
	


	
	
	
	
</mapper>